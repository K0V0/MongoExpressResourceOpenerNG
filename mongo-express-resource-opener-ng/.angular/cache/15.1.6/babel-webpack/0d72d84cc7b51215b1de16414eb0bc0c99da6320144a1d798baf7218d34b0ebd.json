{"ast":null,"code":"import { EnviromentUtil, SettingsNames } from 'src/app/_base/utils/enviroment.util';\nimport { KeyValuePair, Settings } from './query.service';\nimport * as i0 from \"@angular/core\";\nexport class QueryServiceImpl {\n  constructor() {\n    //FIXME dependency injection on various enviroments\n    this.storeService = EnviromentUtil.getStoreService();\n  }\n  open(resourceId) {\n    var context = this;\n    return new Promise((resolve, reject) => {\n      if (resourceId === undefined || resourceId === null || resourceId.trim().length < 1) {\n        reject(false);\n      } else {\n        context.check(resourceId);\n      }\n    });\n  }\n  /** HELPING METHODS ------------------------------------------------------------------------------------------- */\n  check(resourceId) {\n    var context = this;\n    return Promise.all([context.loadAllSettings()]).then(settings => {\n      context.fireRequests(resourceId, settings);\n    });\n  }\n  fireRequests(resourceId, settings) {\n    var context = this;\n    return new Promise((resolve, reject) => {\n      let requestsPromises = context.getDatasourcesUrls(settings, resourceId).map(url => fetch(url));\n      Promise.allSettled(requestsPromises).then(responses => {\n        console.log('RESPONSE');\n        console.log(responses);\n        //TODO continue \n        // https://github.com/K0V0/mongoExpressResourceOpener/blob/51896f6e3b8b78b1a9234c58790a93c92f22d74f/js/background_helper.js#L109\n      });\n    });\n  }\n\n  getDatasourcesUrls(settings, resourceId) {\n    let searchEverywhere = this.extractSetting(settings, SettingsNames.CHECK_ON_ALL_ENVIROMENTS);\n    let currentEnviroment = this.extractSetting(settings, SettingsNames.CURRENT_ENVIROMENT);\n    return this.extractSetting(settings, SettingsNames.ENVIROMENTS).filter(enviroment => searchEverywhere ? true : enviroment.id === currentEnviroment).flatMap(enviroment => enviroment.datasets).map(datasourceUrl => datasourceUrl.lastIndexOf(\"/\") === datasourceUrl.length ? datasourceUrl : datasourceUrl + \"/\").map(datasourceUrl => datasourceUrl + \"\\\"\" + resourceId + \"\\\"\");\n  }\n  loadAllSettings() {\n    return new Promise((resolve, reject) => {\n      let settingsPromises = [];\n      Object.values(SettingsNames).forEach(settingName => {\n        settingsPromises.push(this.storeService.loadWithKey(settingName));\n      });\n      Promise.allSettled(settingsPromises).then(results => {\n        let settings = [];\n        results.forEach(result => {\n          //TODO really need to be that shitty ? ask stackoverflow why cannot have prettier one liner\n          if (result.status === 'fulfilled') {\n            settings.push(result.value);\n          }\n        });\n        resolve(settings);\n      }).catch(() => {\n        reject('Error during loading settings from store - promises settling');\n      });\n    });\n  }\n  extractSetting(settings, settingType) {\n    return settings.flatMap(setting => setting).filter(setting => Object.keys(setting)[0] === settingType).find(x => x)[settingType];\n  }\n}\nQueryServiceImpl.ɵfac = function QueryServiceImpl_Factory(t) {\n  return new (t || QueryServiceImpl)();\n};\nQueryServiceImpl.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: QueryServiceImpl,\n  factory: QueryServiceImpl.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["EnviromentUtil","SettingsNames","KeyValuePair","Settings","QueryServiceImpl","constructor","storeService","getStoreService","open","resourceId","context","Promise","resolve","reject","undefined","trim","length","check","all","loadAllSettings","then","settings","fireRequests","requestsPromises","getDatasourcesUrls","map","url","fetch","allSettled","responses","console","log","searchEverywhere","extractSetting","CHECK_ON_ALL_ENVIROMENTS","currentEnviroment","CURRENT_ENVIROMENT","ENVIROMENTS","filter","enviroment","id","flatMap","datasets","datasourceUrl","lastIndexOf","settingsPromises","Object","values","forEach","settingName","push","loadWithKey","results","result","status","value","catch","settingType","setting","keys","find","x","factory","providedIn"],"sourceRoot":"","sources":["/home/kovo/Documents/PROJEKTY GitHub/MongoExpressResourceOpenerNG/mongo-express-resource-opener-ng/src/app/_base/services/query.service.impl.ts"],"sourcesContent":["import { Injectable } from \"@angular/core\";\nimport { EnviromentUtil, SettingsNames } from 'src/app/_base/utils/enviroment.util';\nimport { DataSetsStoreRecordFormat } from './../components/_base/data-sets/data-sets.interfaces';\nimport { KeyValuePair, QueryService, Settings } from './query.service';\nimport { StoreService } from './store.service';\n\n\n@Injectable({\n    providedIn : 'root'\n})\nexport class QueryServiceImpl implements QueryService {\n\n    private storeService : StoreService;\n    \n    constructor() {\n        //FIXME dependency injection on various enviroments\n        this.storeService = EnviromentUtil.getStoreService();\n    }\n\n\n    public open(resourceId : string | undefined) : Promise<boolean> {\n        var context = this;\n        return new Promise((resolve, reject) => {\n            if (resourceId === undefined || resourceId === null || resourceId.trim().length < 1) {\n                reject(false);\n            } else {\n                context.check(resourceId)\n            }\n        });\n    }\n\n    /** HELPING METHODS ------------------------------------------------------------------------------------------- */\n\n    private check(resourceId : string) : Promise<any> {\n        var context = this;\n        return Promise.all([\n            context.loadAllSettings()\n        ])\n        .then((settings : Settings) => {\n            context.fireRequests(resourceId, settings)\n        });\n    }\n\n    private fireRequests(resourceId : string, settings : Settings) : Promise<any> {\n        var context = this;\n        return new Promise((resolve, reject) => { \n\n            let requestsPromises : Promise<any>[] = context\n                .getDatasourcesUrls(settings, resourceId)\n                .map((url) => fetch(url))\n\n            Promise.allSettled(requestsPromises)\n                .then((responses) => {\n                    console.log('RESPONSE');\n                    console.log(responses);\n                    //TODO continue \n                    // https://github.com/K0V0/mongoExpressResourceOpener/blob/51896f6e3b8b78b1a9234c58790a93c92f22d74f/js/background_helper.js#L109\n                })\n        });\n    }\n\n    private getDatasourcesUrls(settings : Settings, resourceId : string) : string[] {\n\n        let searchEverywhere : boolean = this.extractSetting(settings, SettingsNames.CHECK_ON_ALL_ENVIROMENTS);\n        let currentEnviroment : number = this.extractSetting(settings, SettingsNames.CURRENT_ENVIROMENT);\n\n        return this.extractSetting(settings, SettingsNames.ENVIROMENTS)\n                .filter((enviroment : DataSetsStoreRecordFormat) => searchEverywhere ? true : enviroment.id === currentEnviroment)\n                .flatMap((enviroment : DataSetsStoreRecordFormat) => enviroment.datasets)\n                .map((datasourceUrl : string) => (datasourceUrl.lastIndexOf(\"/\") === datasourceUrl.length) ? datasourceUrl : datasourceUrl + \"/\")\n                .map((datasourceUrl :string) => datasourceUrl + \"\\\"\" + resourceId + \"\\\"\");\n    }\n\n    private loadAllSettings() : Promise<Settings> {\n        return new Promise((resolve, reject) => {\n\n            let settingsPromises : Promise<KeyValuePair>[] = [];\n            Object.values(SettingsNames).forEach((settingName : string) => {\n                settingsPromises.push(this.storeService.loadWithKey(settingName));\n            })\n\n            Promise.allSettled(settingsPromises)\n                .then((results) => {\n                    let settings : Settings = []; \n                    results.forEach((result) => {\n                        //TODO really need to be that shitty ? ask stackoverflow why cannot have prettier one liner\n                        if (result.status === 'fulfilled') {\n                            settings.push(result.value);\n                        }\n                    });\n                    resolve(settings);\n                })\n                .catch(() => {\n                    reject('Error during loading settings from store - promises settling');\n                })\n        });\n    }\n\n    private extractSetting(settings : Settings, settingType : SettingsNames) : any {\n        return settings\n            .flatMap((setting) => setting)\n            .filter((setting : KeyValuePair) => Object.keys(setting)[0] === settingType)\n            .find((x) => x)[settingType]\n    }\n\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}